

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω C√† ph√™</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
          background: #f8f9fa;
        }
        .tab-pane {
          padding-top: 20px;
        }
        .nav-tabs .nav-link {
          font-weight: 500;
        }
        .nav-tabs .nav-link.active {
          background-color: #0d6efd;
          color: white;
          border-radius: 0.375rem;
        }
        h1, h3 {
          font-weight: bold;
        }
      </style>
</head>


<body>
    <h1 class="text-center mb-4">Qu·∫£n l√Ω Qu√°n C√† Ph√™</h1>

    <ul class="nav nav-tabs mb-4" id="menuTabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#tabThucDon">Danh s√°ch m√≥n</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#tabDatBan">Qu·∫£n l√≠ b√†n</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#tabDonHang">ƒê∆°n ƒë·∫∑t h√†ng</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#tabBieuDo">C√°c bi·ªÉu ƒë·ªì</a>
        </li>
        

      </ul>
      
      
      <div class="tab-content">
        <!-- Danh s√°ch m√≥n -->
        <div class="tab-pane fade show active" id="tabThucDon">
          <h3>Danh s√°ch m√≥n</h3>
          <table class="table table-striped" id="thucDonTable">
            <thead>
              <tr>
                <th>ID M√≥n</th>
                <th>T√™n M√≥n</th>
                <th>Gi√° B√°n</th>
                <th>T√™n Danh M·ª•c</th>
                <th>Gi·ªõi Thi·ªáu</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
      
          <h3>Th√™m m√≥n m·ªõi</h3>
          <form id="formAddMon">
            <div class="mb-3">
              <label class="form-label">ID M√≥n</label>
              <input type="text" class="form-control" id="idMon" required>
            </div>
            <div class="mb-3">
              <label class="form-label">T√™n m√≥n</label>
              <input type="text" class="form-control" id="tenMon" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Gi√° b√°n</label>
              <input type="number" class="form-control" id="giaBan" required>
            </div>
            <div class="mb-3">
              <label class="form-label">T√™n danh m·ª•c</label>
              <select class="form-select" id="idDanhMuc" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Gi·ªõi thi·ªáu</label>
              <textarea class="form-control" id="gioiThieuMon" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">Th√™m m√≥n</button>
          </form>
        </div>
      
        <!-- Danh s√°ch ƒë·∫∑t b√†n -->
        <div class="tab-pane fade" id="tabDatBan">
          <h3 class="mt-3">Danh s√°ch ƒë·∫∑t b√†n</h3>
          <div class="row g-2 mb-3">
            <div class="col"><input type="text" class="form-control" id="searchId" placeholder="ID"></div>
            <div class="col"><input type="text" class="form-control" id="searchBan" placeholder="B√†n"></div>
            <div class="col"><input type="text" class="form-control" id="searchTenKhach" placeholder="T√™n Kh√°ch ƒê·∫∑t"></div>
            <div class="col"><input type="date" class="form-control" id="searchNgay"></div>
            <div class="col"><input type="time" class="form-control" id="searchGio"></div>
            <div class="col">
              <select class="form-select" id="searchTrangThai">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="ƒê√£ ƒë·∫∑t">ƒê√£ ƒë·∫∑t</option>
                <option value="ƒê√£ s·ª≠ d·ª•ng">ƒê√£ s·ª≠ d·ª•ng</option>
                <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
              </select>
            </div>
            <div class="col">
              <button class="btn btn-primary w-100" onclick="loadDatBan()">T√¨m ki·∫øm</button>
            </div>
          </div>
          <table class="table table-striped" id="datBanTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>B√†n</th>
                <th>T√™n Kh√°ch ƒê·∫∑t</th>
                <th>Ng√†y</th>
                <th>Gi·ªù</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="banTrongList" class="mt-4"></div>
        </div>
      
        <!-- C√°c bi·ªÉu ƒë·ªì -->
        <div class="tab-pane fade" id="tabBieuDo">
          <h3 class="mt-3">üìä Bi·ªÉu ƒë·ªì doanh thu theo th√°ng</h3>
          <canvas id="doanhThuChart" height="120"></canvas>
          <h3 class="mt-5">üìä Bi·ªÉu ƒë·ªì doanh thu theo qu√Ω</h3>
          <canvas id="chartQuy" height="100"></canvas>
          <h3 class="mt-5">üìä Bi·ªÉu ƒë·ªì doanh thu theo nƒÉm</h3>
          <canvas id="chartNam" height="100"></canvas>
        </div>
        <!-- Danh s√°ch ƒë∆°n ƒë·∫∑t h√†ng online -->
        <div class="tab-pane fade" id="tabDonHang">
  <h3 class="mt-3">üõí Danh s√°ch ƒë∆°n h√†ng ch·ªù x√°c nh·∫≠n</h3>
  <table class="table table-bordered" id="donHangTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Ng∆∞·ªùi nh·∫≠n</th>
        <th>SƒêT</th>
        <th>ƒê·ªãa ch·ªâ</th>
        <th>T·ªïng ti·ªÅn</th>
        <th>Tr·∫°ng th√°i</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>



      </div>
              <!-- Modal t·∫°o h√≥a ƒë∆°n -->
<div class="modal fade" id="modalHoaDon" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formHoaDon">
        <div class="modal-header">
          <h5 class="modal-title">T·∫°o h√≥a ƒë∆°n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="khachMoiInfo" class="mb-3" style="display: none;">
            <input class="form-control mb-2" id="tenKhachMoi" placeholder="T√™n kh√°ch h√†ng">
            <input class="form-control" id="sdtKhachMoi" placeholder="SƒêT kh√°ch h√†ng">
          </div>
          <div id="dsMon"></div>
          <div class="mb-3">
            <label for="pttt" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select class="form-select" id="pttt" required>
              <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
              <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
              <option value="VNPAY">VNPAY</option>
            </select>
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">X√°c nh·∫≠n</button>
        </div>
      </form>
    </div>
  </div>
</div>



<script>
    
function showAlert(type, title, text) {
    Swal.fire({ icon: type, title: title, text: text });
}

function loadDanhMucDropdown() {
    fetch('https://be-qlcf.onrender.com/api/danhmuc')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('idDanhMuc');
            select.innerHTML = '';
            data.forEach(dm => {
                select.innerHTML += `<option value="${dm.idDanhMuc}">${dm.tenDanhMuc}</option>`;
            });
        })
        .catch(() => showAlert("error", "Qu·∫£n l√Ω C√† ph√™", "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh m·ª•c!"));
}

function loadThucDon() {
    fetch('https://be-qlcf.onrender.com/api/thucdon_full')
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector('#thucDonTable tbody');
            tbody.innerHTML = '';
            data.forEach(mon => {
                const row = document.createElement('tr');
                row.dataset.id = mon.idMon;
                row.innerHTML = `
                    <td>${mon.idMon}</td>
                    <td>${mon.tenMon}</td>
                    <td>${mon.giaBan}</td>
                    <td>${mon.tenDanhMuc}</td>
                    <td>${mon.gioiThieuMon}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-edit">S·ª≠a</button>
                        <button class="btn btn-sm btn-danger btn-delete">X√≥a</button>
                    </td>`;
                tbody.appendChild(row);
            });
            attachRowEvents();
        });
}

function attachRowEvents() {
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = function () {
            const row = this.closest('tr');
            const cells = row.querySelectorAll('td');
            if (this.textContent === "S·ª≠a") {
                for (let i = 1; i <= 4; i++) cells[i].setAttribute("contenteditable", "true");
                this.textContent = "L∆∞u";
                this.classList.remove("btn-primary");
                this.classList.add("btn-success");
            } else {
                const mon = {
                    idMon: cells[0].textContent.trim(),
                    tenMon: cells[1].textContent.trim(),
                    giaBan: parseFloat(cells[2].textContent.trim()),
                    tenDanhMuc: cells[3].textContent.trim(),
                    gioiThieuMon: cells[4].textContent.trim()
                };
                fetch('https://be-qlcf.onrender.com/api/suamon', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mon)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.error?.includes("duplicate")) {
                        showAlert("error", "Qu·∫£n l√Ω C√† ph√™", "M√£ m√≥n ho·∫∑c t√™n m√≥n ƒë√£ t·ªìn t·∫°i!");
                    } else {
                        showAlert("success", "Qu·∫£n l√Ω C√† ph√™", data.message || data.error);
                        loadThucDon();
                    }
                });
            }
        }
    });

    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = function () {
            const idMon = this.closest('tr').dataset.id;
            Swal.fire({
                title: 'X√°c nh·∫≠n',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`https://be-qlcf.onrender.com/api/xoamon/${idMon}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            showAlert("success", "Qu·∫£n l√Ω C√† ph√™", data.message || data.error);
                            loadThucDon();
                        });
                }
            });
        }
    });
}

function loadDatBan() {
    fetch('https://be-qlcf.onrender.com/api/datban')
        .then(res => res.json())
        .then(data => {
            const searchId = document.getElementById("searchId").value.toLowerCase();
            const searchBan = document.getElementById("searchBan").value.toLowerCase();
            const searchTenKhach = document.getElementById("searchTenKhach").value.toLowerCase();
            const searchNgay = document.getElementById("searchNgay").value;
            const searchGio = document.getElementById("searchGio").value;
            const searchTrangThai = document.getElementById("searchTrangThai").value;

            const tbody = document.querySelector('#datBanTable tbody');
            tbody.innerHTML = '';

            data.datBan
                .filter(item =>
                    item.id.toLowerCase().includes(searchId) &&
                    item.ban.toLowerCase().includes(searchBan) &&
                    item.tenKhach.toLowerCase().includes(searchTenKhach) &&
                    (searchNgay === "" || item.ngay === searchNgay) &&
                    (searchGio === "" || item.gio.startsWith(searchGio)) &&
                    (searchTrangThai === "" || item.trangThai === searchTrangThai)
                )
                .forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.ban}</td>
                            <td>${item.tenKhach}</td>
                            <td>${item.ngay}</td>
                            <td>${item.gio}</td>
                            <td>
                              <span class="badge 
                                ${item.trangThai === 'ƒê√£ ƒë·∫∑t' ? 'bg-warning text-dark' : 
                                  item.trangThai === 'ƒê√£ s·ª≠ d·ª•ng' ? 'bg-success' :
                                  item.trangThai === 'ƒê√£ h·ªßy' ? 'bg-danger' : ''}">
                                ${item.trangThai}
                              </span>
                            </td>
                            <td>
                              ${item.trangThai === "ƒê√£ ƒë·∫∑t" ? `<button class="btn btn-success btn-sm" onclick="moModalHoaDon('${item.ban}', false)">T·∫°o h√≥a ƒë∆°n</button>` : ""}
                            </td>


                        </tr>`;
                });
            // 3. Hi·ªÉn th·ªã danh s√°ch b√†n tr·ªëng
            const banTrongContainer = document.getElementById("banTrongList");
            banTrongContainer.innerHTML = "<h5>ü™ë C√°c b√†n ƒëang tr·ªëng:</h5>";

            if (data.banTrong.length === 0) {
                banTrongContainer.innerHTML += "<p class='text-muted'>Hi·ªán kh√¥ng c√≤n b√†n n√†o tr·ªëng.</p>";
            } else {
                const list = document.createElement("ul");
                list.className = "list-group";
                data.banTrong.forEach(ban => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `
                      <span>${ban.idBan} - ${ban.tenBan}</span>
                      <button class="btn btn-sm btn-primary" onclick="moModalPhucVuKhach('${ban.idBan}')">Ph·ª•c v·ª• kh√°ch m·ªõi</button>
                    `;  
                    list.appendChild(li);
                    
                });
                banTrongContainer.appendChild(list);
            }   
        })
        .catch(() => showAlert("error", "Qu·∫£n l√Ω C√† ph√™", "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ƒë·∫∑t b√†n!"));
}


document.getElementById("formAddMon").addEventListener("submit", function (e) {
    e.preventDefault();
    const mon = {
        idMon: document.getElementById("idMon").value,
        tenMon: document.getElementById("tenMon").value,
        giaBan: document.getElementById("giaBan").value,
        idDanhMuc: document.getElementById("idDanhMuc").value,
        gioiThieuMon: document.getElementById("gioiThieuMon").value
    };
    fetch('https://be-qlcf.onrender.com/api/themmon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mon)
    })
    .then(res => res.json())
    .then(data => {
        if (data.error?.includes("duplicate")) {
            showAlert("error", "Qu·∫£n l√Ω C√† ph√™", "M√£ m√≥n ho·∫∑c t√™n m√≥n ƒë√£ t·ªìn t·∫°i!");
        } else {
            showAlert("success", "Qu·∫£n l√Ω C√† ph√™", data.message || 'Th√™m m√≥n th√†nh c√¥ng');
            document.getElementById("formAddMon").reset();
            loadThucDon();
        }
    });
});
// Khai b√°o bi·∫øn to√†n c·ª•c ƒë·ªÉ gi·ªØ Chart instance
let chartThang, chartQuy, chartNam;

function loadThongKeDoanhThu() {
    fetch("https://be-qlcf.onrender.com/api/thongke/doanhthu")
        .then(res => res.json())
        .then(data => {
            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (chartThang) chartThang.destroy();
            if (chartQuy) chartQuy.destroy();
            if (chartNam) chartNam.destroy();

            // === TH√ÅNG ===
            chartThang = new Chart(document.getElementById('doanhThuChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.theoThang),
                    datasets: [{
                        label: 'Doanh thu theo th√°ng (VNƒê)',
                        data: Object.values(data.theoThang),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // === QU√ù ===
            chartQuy = new Chart(document.getElementById('chartQuy').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.theoQuy),
                    datasets: [{
                        label: 'Doanh thu theo qu√Ω (VNƒê)',
                        data: Object.values(data.theoQuy),
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // === NƒÇM ===
            chartNam = new Chart(document.getElementById('chartNam').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.theoNam),
                    datasets: [{
                        label: 'Doanh thu theo nƒÉm (VNƒê)',
                        data: Object.values(data.theoNam),
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        })
        .catch(err => {
            console.error("‚ùå Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ doanh thu:", err);
        });
}
let currentBan = "";
let isKhachMoi = false;

function moModalHoaDon(idBan, khachMoi = false) {
  currentBan = idBan;
  isKhachMoi = khachMoi;
  document.getElementById("khachMoiInfo").style.display = khachMoi ? "block" : "none";

  // Load danh s√°ch m√≥n
  fetch("https://be-qlcf.onrender.com/api/thucdon")
    .then(res => res.json())
    .then(data => {
      const dsMon = document.getElementById("dsMon");
      dsMon.innerHTML = "";
      data.forEach(mon => {
        dsMon.innerHTML += `
          <div class="input-group mb-2">
            <span class="input-group-text">${mon.tenMon}</span>
            <input type="number" class="form-control soLuongMon" data-id="${mon.idMon}" placeholder="S·ªë l∆∞·ª£ng" min="0">
          </div>`;
      });
    });

  new bootstrap.Modal(document.getElementById("modalHoaDon")).show();
}

document.getElementById("formHoaDon").addEventListener("submit", function(e) {
  e.preventDefault();

  const danhSachMon = [];
  document.querySelectorAll(".soLuongMon").forEach(input => {
    const sl = parseInt(input.value);
    if (sl > 0) {
      danhSachMon.push({ idMon: input.dataset.id, soLuong: sl });
    }
  });

  if (danhSachMon.length === 0) {
    return Swal.fire("L·ªói", "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n!", "error");
  }

  const khachMoi = {
    ten: document.getElementById("tenKhachMoi")?.value || "",
    sdt: document.getElementById("sdtKhachMoi")?.value || ""
  };

  const duLieu = {
    idBan: currentBan,
    mon: danhSachMon,
    isKhachMoi: isKhachMoi,
    khachMoi: khachMoi,
    phuongthucThanhToan: "Ti·ªÅn m·∫∑t"
  };

  fetch("https://be-qlcf.onrender.com/api/taohoadon", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(duLieu)
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        Swal.fire("L·ªói", data.error, "error");
      } else {
        Swal.fire("Th√†nh c√¥ng", data.message, "success").then(() => {
          document.getElementById("formHoaDon").reset();
          document.querySelector(".btn-close").click();
          loadDatBan(); // reload danh s√°ch b√†n
        });
      }
    })
    .catch(err => {
      Swal.fire("L·ªói", "Kh√¥ng th·ªÉ k·∫øt n·ªëi server", "error");
    });
});
function moModalPhucVuKhach(idBan) {
  moModalHoaDon(idBan, true);
}
function loadDonHangChoDuyet() {
  fetch("https://be-qlcf.onrender.com/api/donhang/cho_duyet")
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#donHangTable tbody");
      tbody.innerHTML = "";
      data.forEach(dh => {
        tbody.innerHTML += `
          <tr>
            <td>${dh.idDonHang}</td>
            <td>${dh.ten}</td>
            <td>${dh.sdt}</td>
            <td>${dh.diaChi}</td>
            <td>${dh.tongTien} VNƒê</td>
            <td><span class="badge bg-warning text-dark">${dh.trangThai}</span></td>
            <td><button class="btn btn-success btn-sm" onclick="duyetDon('${dh.idDonHang}')">Duy·ªát</button></td>
          </tr>`;
      });
    });
}

function duyetDon(id) {
  fetch(`https://be-qlcf.onrender.com/api/duyet_donhang/${id}`, {
    method: "PUT"
  })
    .then(res => res.json())
    .then(data => {
      Swal.fire("Th√†nh c√¥ng", data.message, "success");
      loadDonHangChoDuyet();
    });
}


</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabElList = document.querySelectorAll('#menuTabs a[data-bs-toggle="tab"]');
        
        tabElList.forEach(function (tabEl) {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                const tabId = event.target.getAttribute('href');
    
                if (tabId === "#tabThucDon") {
                    loadDanhMucDropdown();
                    loadThucDon();
                } else if (tabId === "#tabDatBan") {
                    loadDatBan();
                } else if (tabId === "#tabBieuDo") {
                    loadThongKeDoanhThu();
                }else if (tabId === "#tabDonHang") {
                    loadDonHangChoDuyet(); 
                }
            });
        });
        loadDanhMucDropdown();  
        loadThucDon();
    });
    </script>
    
</body>
</html>
