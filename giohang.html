<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giá» hÃ ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet" />
  <style>#map { height: 400px; border-radius: 8px; margin-top: 10px; }</style>
</head>
<body class="bg-light">
<div class="container py-5">
  <h2 class="mb-4">ğŸ›’ Giá» hÃ ng cá»§a báº¡n</h2>
  <div class="mb-3 text-end">
  <a href="xemtrangthai.html" class="btn btn-outline-info">
    ğŸ“‹ Xem tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
  </a>
</div>

  <div id="cart-container"></div>

  <hr>
  <h4>ThÃ´ng tin giao hÃ ng</h4>
  <form id="checkout-form">
    <div class="mb-3">
      <input type="text" class="form-control" id="ten" placeholder="Há» tÃªn ngÆ°á»i nháº­n" required>
    </div>
    <div class="mb-3">
      <input type="tel" class="form-control" id="sdt" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i" required>
    </div>
    <div id="geocoder" class="mb-3"></div>
    

    <div id="map"></div>
    <p class="mt-2">
      ğŸ“ Khoáº£ng cÃ¡ch: <span id="distance">-</span> km<br>
      ğŸ• Æ¯á»›c tÃ­nh thá»i gian giao: <span id="duration">-</span> phÃºt<br>
      ğŸšš PhÃ­ giao hÃ ng: <span id="fee">-</span> VNÄ
    </p>
    <div class="mb-3">
  <label class="form-label">PhÆ°Æ¡ng thá»©c thanh toÃ¡n</label><br>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="payment" id="cash" value="cash" checked>
    <label class="form-check-label" for="cash">Tiá»n máº·t khi nháº­n</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="payment" id="vnpay" value="vnpay">
    <label class="form-check-label" for="vnpay">Chuyá»ƒn khoáº£n (VietQR)</label>
  </div>
    <button type="submit" class="btn btn-primary">XÃ¡c nháº­n Ä‘Æ¡n hÃ ng</button>
  </div>

  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
<script>


const cart = JSON.parse(localStorage.getItem("cart")) || [];
const container = document.getElementById("cart-container");
// ğŸ§  Tá»± Ä‘á»™ng Ä‘iá»n há» tÃªn vÃ  SÄT náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p
const hoTen = localStorage.getItem("ten");
const sdt = localStorage.getItem("sdt");

if (hoTen) document.getElementById("ten").value = hoTen;
if (sdt) document.getElementById("sdt").value = sdt;

function renderCart() {
  const container = document.getElementById("cart-container");
  if (cart.length === 0) {
    container.innerHTML = "<p class='text-muted'>Giá» hÃ ng Ä‘ang trá»‘ng.</p>";
    return;
  }

  let html = `<table class="table table-bordered">
    <thead><tr>
      <th>Sáº£n pháº©m</th>
      <th>GiÃ¡</th>
      <th>Sá»‘ lÆ°á»£ng</th>
      <th>ThÃ nh tiá»n</th>
      <th></th>
    </tr></thead><tbody>`;

  let tongTien = 0;
  cart.forEach((item, index) => {
    const thanhTien = item.soLuong * item.gia;
    tongTien += thanhTien;
    html += `<tr>
      <td>${item.ten}</td>
      <td>${item.gia.toLocaleString()} VNÄ</td>
      <td>
        <input type="number" min="1" class="form-control form-control-sm" 
          value="${item.soLuong}" onchange="updateQuantity(${index}, this.value)">
      </td>
      <td>${thanhTien.toLocaleString()} VNÄ</td>
      <td><button class="btn btn-sm btn-danger" onclick="removeItem(${index})">XÃ³a</button></td>
    </tr>`;
  });

  html += `</tbody></table>
    <h5>Tá»•ng cá»™ng: <strong>${tongTien.toLocaleString()} VNÄ</strong></h5>`;

  container.innerHTML = html;
}

function updateQuantity(index, newQty) {
  newQty = parseInt(newQty);
  if (newQty < 1) return;

  cart[index].soLuong = newQty;
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart(); // Cáº­p nháº­t láº¡i giao diá»‡n thay vÃ¬ reload
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

// Gá»i render ban Ä‘áº§u
renderCart();

let isVNPaid = false;
document.getElementById("checkout-form").addEventListener("submit", function(e) {
  e.preventDefault();
  
  const phiShip = Number(document.getElementById("fee")?.textContent?.replace(/[^\d]/g, "")) || 0;
  const diaChi = document.querySelector("#geocoder input")?.value || '';
  const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
  const totalAmount = cart.reduce((sum, item) => sum + item.soLuong * item.gia, 0) + phiShip;

  const donHang = {
    ten: document.getElementById("ten").value,
    sdt: document.getElementById("sdt").value,
    diaChi: diaChi,
    phiShip: phiShip,
    gioHang: cart,
    thanhToan: paymentMethod,
    idAccount: localStorage.getItem("userId")  // ğŸ‘ˆ gá»­i idAccount

  };

  // Náº¿u lÃ  thanh toÃ¡n qua VNPAY vÃ  chÆ°a thanh toÃ¡n
  if (paymentMethod === "vnpay" && !isVNPaid) {
    const qrUrl = `https://api.vietqr.io/image/970441-335757499-t5b8xuk.jpg?accountName=DINH%20VAN%20VINH&amount=${totalAmount}`;

    const popup = window.open("", "QR", "width=400,height=500");
    popup.document.write(`
      <h3>ğŸ“² Vui lÃ²ng quÃ©t mÃ£ QR Ä‘á»ƒ thanh toÃ¡n</h3>
      <img src="${qrUrl}" style="width:100%">
      <p style="margin-top:10px;">Sau khi thanh toÃ¡n xong, hÃ£y quay láº¡i vÃ  báº¥m <strong>XÃ¡c nháº­n Ä‘Æ¡n hÃ ng</strong> láº§n ná»¯a.</p>
    `);

    isVNPaid = true;
    return; // Dá»«ng táº¡i Ä‘Ã¢y chá» xÃ¡c nháº­n láº¡i
  }



  fetch("http://127.0.0.1:5000/api/donhang", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(donHang)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("âœ… ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng!");
        localStorage.removeItem("cart");
        location.reload();
      } else {
        alert("âŒ Gá»­i Ä‘Æ¡n hÃ ng tháº¥t báº¡i: " + data.message);
      }
    })
    .catch(err => {
      alert("âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n server!");
      console.error(err);
    });
});

mapboxgl.accessToken = 'pk.eyJ1IjoidmluaDI4MDUwNCIsImEiOiJjbWJpNzdlN3AwMnhjMmxzOGZmb283am55In0.UQ-jAZ6QZP9JjCeSx1rk-Q';
const storeLocation = [105.854444, 21.028511];
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: storeLocation,
  zoom: 12
});

new mapboxgl.Marker({ color: 'green' })
  .setLngLat(storeLocation)
  .setPopup(new mapboxgl.Popup().setText("Cá»­a hÃ ng CoffeeShop"))
  .addTo(map);

let userMarker = null;

const geocoder = new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl,
  placeholder: "Nháº­p Ä‘á»‹a chá»‰ hoáº·c chá»n trÃªn báº£n Ä‘á»“",
  marker: false
});

document.getElementById("geocoder").appendChild(geocoder.onAdd(map));

function handleCustomerLocation(customerLocation) {
  if (userMarker) userMarker.remove();
  userMarker = new mapboxgl.Marker({ color: 'red' })
    .setLngLat(customerLocation)
    .setPopup(new mapboxgl.Popup().setText("Vá»‹ trÃ­ cá»§a báº¡n"))
    .addTo(map);

  fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${storeLocation.join(',')};${customerLocation.join(',')}?access_token=${mapboxgl.accessToken}`)
    .then(res => res.json())
    .then(data => {
      const route = data.routes[0];
      const km = (route.distance / 1000).toFixed(2);
      const minutes = Math.round(route.duration / 60);
      const fee = Math.ceil(km * 2000);

      document.getElementById("distance").textContent = km;
      document.getElementById("duration").textContent = minutes;
      document.getElementById("fee").textContent = fee.toLocaleString();
    });
}

map.on('click', (e) => {
  const customerLocation = [e.lngLat.lng, e.lngLat.lat];
  handleCustomerLocation(customerLocation);

  // ğŸ‘‰ Gá»i reverse geocoding Ä‘á»ƒ láº¥y Ä‘á»‹a chá»‰
  fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${customerLocation[0]},${customerLocation[1]}.json?access_token=${mapboxgl.accessToken}`)
    .then(res => res.json())
    .then(data => {
      const placeName = data.features[0]?.place_name || "";
      const geocoderInput = document.querySelector("#geocoder input");
        if (geocoderInput) {
           geocoderInput.value = placeName;
        }

    });
});


geocoder.on('result', (e) => {
  const customerLocation = e.result.center;
  handleCustomerLocation(customerLocation);
});
</script>
</body>
</html>
